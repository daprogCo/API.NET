name: Deploy to VPS (Test Fast)

on:
  push:
    branches:
      - master

jobs:
  deploy:
    name: Quick Deploy to VPS
    runs-on: ubuntu-latest

    steps:
      - name: Set up SSH key (no known_hosts)
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.VPS_SSH_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa

      - name: Deploy via SSH (fail on any error)
        run: |
          ssh -o StrictHostKeyChecking=no ${{ secrets.VPS_HOST }} << 'EOF'
            set -euo pipefail

            echo "ðŸ“ Moving to project folder..."
            cd ~/Projects/API.NET || { echo 'âŒ Project folder not found'; exit 1; }

            echo "ðŸ”„ Pulling latest code..."
            git pull --rebase || { echo 'âŒ git pull failed'; exit 1; }

            echo "âœ… Code updated."

            echo "ðŸ§ª Validating docker-compose configuration..."
            docker-compose config || { echo 'âŒ docker-compose config failed'; exit 1; }

            echo "ðŸ§¹ Stopping existing containers..."
            docker-compose down --remove-orphans || { echo 'âŒ docker-compose down failed'; exit 1; }

            echo "ðŸ—ï¸ Rebuilding containers (no cache, pull latest images)..."
            docker-compose build --no-cache --pull || { echo 'âŒ docker-compose build failed'; exit 1; }

            echo "ðŸš€ Starting containers..."
            docker-compose up -d || { echo 'âŒ docker-compose up failed'; exit 1; }

            echo "ðŸ“¡ Current containers:"
            docker ps --format 'table {{.Names}}\t{{.Status}}\t{{.Image}}'

            echo "âœ… Deployment complete!"
          EOF

